#!/bin/sh
# Pre-commit hook for AgentForge

set -e

echo "üîç Running pre-commit validation..."

# Check if this is a merge commit
if git rev-parse -q --verify MERGE_HEAD >/dev/null; then
    echo "‚ÑπÔ∏è  Merge commit detected, skipping pre-commit hooks"
    exit 0
fi

# Check for WIP commits
commit_msg=$(git log --format=%B -n 1 HEAD 2>/dev/null || echo "")
if echo "$commit_msg" | grep -qi "wip\|work in progress\|fixup\|squash"; then
    echo "‚ö†Ô∏è  WIP commit detected, skipping validation"
    exit 0
fi

# 1. File size validation
echo "üìè Checking file sizes..."
if ! ./scripts/check-file-length.sh; then
    echo "‚ùå File size check failed"
    exit 1
fi

# 2. Build validation
echo "üî® Building application..."
if ! make build >/dev/null 2>&1; then
    echo "‚ùå Build failed"
    echo "Run 'make build' to see detailed errors"
    exit 1
fi

# 3. Test execution
echo "üß™ Running tests..."
if ! make test >/dev/null 2>&1; then
    echo "‚ùå Tests failed"
    echo "Run 'make test' to see detailed errors"
    exit 1
fi

# 4. Linting
echo "üîç Running linter..."
if ! make lint >/dev/null 2>&1; then
    echo "‚ùå Linting failed"
    echo "Run 'make lint' to see detailed errors"
    exit 1
fi

# 5. Security check
echo "üîí Running security scan..."
if ! make security-scan >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  Security scan found issues"
    echo "Run 'make security-scan' to see details"
    # Don't fail on security issues, just warn
fi

echo "‚úÖ All pre-commit checks passed!"